name: 'Orleans build y push'
inputs:
  ACR_USERNAME:
    description: "user de acr"
    required: true
    default: ''
  ACR_PASSWORD:
    description: "passwrd de acr"
    required: true
    default: ''
  ACR_NAME:
    description: "nommbre del acr"
    required: true
    default: ''
  ACR_FULL_NAME:
    description: "nombre del acr con azurecr.io"
    required: true
    default: ''
  variable:
    description: "variables que recibo de la llamada al pipeline"
    required: false
  appName:
    description: "Nombre de la aplicacion (dentro del proyecto)"
    required: true
    default: orleans-grain
  teamProject:
    description: "Nombre del proyecto/equipo"
    required: true
    default: qa
  appVersion:
    description: "tag para subir imagen"
    required: true
    default: latest

runs:
  using: "composite"
  steps:
      - run: echo hi!, we working.
        shell: bash
        # Setup .NET Core SDK
      - name: checkout
        uses: actions/checkout@v3.5.0 #actions/checkout@v2
        with:
          fetch-depth: 0
# Se debe sacar si se utiliza la estrategia de RH
     - name: setear docker
       uses: docker/setup-buildx-action@v3
       with:
          install: true
      - name: Run a multi-line script
        shell: bash
        run: |-
          echo  ${{ inputs.ACR_USERNAME }}
          echo ${{ inputs.ACR_PASSWORD }}
          echo ${{inputs.teamProject}}-${{inputs.appName}}

     - name: Login to Azure Container Registry
       uses: azure/docker-login@v1
       with:
         login-server: ${{ inputs.ACR_NAME }}.azurecr.io 
         username: ${{ inputs.ACR_USERNAME }}
         password: ${{ inputs.ACR_PASSWORD }}

    #  - name: Podman Login
    #    uses: redhat-actions/podman-login@v1.6
    #    with:
    #      registry: ${{ inputs.ACR_NAME }}.azurecr.io #ACR_FULL_NAME incluye el azurecr.io
    #      username: ${{ inputs.ACR_USERNAME }}
    #      password: ${{ inputs.ACR_PASSWORD }}
    #      auth_file_path: /tmp/podman/auth.json

     - name: Build and push
       uses: docker/build-push-action@v5
       with:
         context: . 
         file: Dockerfile 
         push: true
         tags: ${{ inputs.ACR_FULL_NAME }}/${{inputs.teamProject}}-${{inputs.appName}}:${{ inputs.appVersion}}

      # Se comenta por los multiples errores al instalar las dependencias de .NET
      # - name: Buildah Action
      #   id: build-image
      #   uses: redhat-actions/buildah-build@v2
      #   with:
      #     image: my-new-image
      #     tags: ${{ inputs.ACR_FULL_NAME }}/${{inputs.teamProject}}-${{inputs.appName}}:${{ inputs.appVersion}}
      #     containerfiles: |
      #       Dockerfile
      #     build-args: |
      #       some_arg=some_value

      # - name: Push To ACR
      #   id: push-to-acr
      #   uses: redhat-actions/push-to-registry@v2
      #   with:
      #     image: ${{ steps.build-image.outputs.image }}
      #     tags: ${{ steps.build-image.outputs.tags }}
      #     registry: ${{ inputs.ACR_NAME }}.azurecr.io
      #     username: ${{ inputs.ACR_USERNAME }}
      #     password: ${{ inputs.ACR_PASSWORD }}

