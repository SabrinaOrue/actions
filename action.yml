name: 'Orleans helm package'
description: Action helm
inputs:
  GHCR_USERNAME:
    description: "user de acr"
    required: true
    default: ''
  GHCR_PASSWORD:
    description: "passwrd de acr"
    required: true
    default: ''
  appName:
    description: "Nombre de la aplicacion (dentro del proyecto)"
    required: true
    default: orleans-grain
  namespace:
    description: "nombre de namespaces"
    required: false
    default: ""
  teamProject:
    description: "Nombre del proyecto/equipo"
    required: true
    default: qa
  appVersion:
    description: "tag para subir imagen"
    required: true
    default: latest
  helmChartVersionLatest:
     description: "VersionHelm"
     required: true
  chartFolder:
    description: 'Nombre de folder del chart de Helm'
    default: 'pythonChart'
  chartName:
    description: 'Nombre de chart de Helm'
    default: 'python-chart'
  environment:
    description: "nombre de environment"
    required: false
    default: ""
  
runs:
  using: "composite"
  steps:
      - run: echo 'Inicia el proceso'
        shell: bash
      
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.3 #Helm 13 tiene un bug
      
      - name: Reviso archivos y version helm
        shell: bash
        run: |-
           ls
           helm version --short

      - uses: actions/download-artifact@v3
        with:
          name: ${{inputs.namespace}}
    
      - name: Helm Lint, verifica helm por errores (deberia ser bloqueante)
        shell: bash
        run: |-
          helmLint="helm lint --values=values.yaml > /dev/null 2>&1"
          if eval "$helmLint"; then
             echo "HELM Lint OK - The template folder and values file format is OK";
          else
             echo "HELM Lint FAIL - There is a problem with the folder 'templates' or the values file format";
             exit 1
          fi

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ inputs.GHCR_USERNAME }}
          password: ${{ inputs.GHCR_PASSWORD }}
        env:
          GITHUB_TOKEN: ${{ inputs.GHCR_PASSWORD }}
    
      - name: Empaquetar y subir helm a ghcr
        shell: bash
        run: |-
          export HELM_EXPERIMENTAL_OCI=1 #Es necesario para el chart save
          helm package ${{ inputs.chartFolder }} --version ${{ inputs.helmChartVersionLatest }}
          helm push ${{ inputs.chartName }}-${{ inputs.helmChartVersionLatest }}.tgz oci://ghcr.io/cortiz2024/demo_app
